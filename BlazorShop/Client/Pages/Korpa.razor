@page "/korpa"
@using BlazorShop.Shared
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NM
@inject Blazored.LocalStorage.ISyncLocalStorageService LS

<h1>Korpa</h1>
<h2>Vas racun</h2>
 
<div>
    <ul>
        @foreach (Artikal a in PoruceniArtikli)
        {
            
            <li><button @onclick="(()=>UkloniIzKorpe(a))" class="btn btn-primary">-</button> @a</li>
        }
    </ul>
</div>

<button class="btn btn-primary" @onclick="ZavrsiRacun">Zavrsi racun</button>



@code {

    public HubConnection KorpaServer;
    
    public Artikal art2 = new Artikal();
    public List<Artikal> PoruceniArtikli = new List<Artikal>();
    public List<Artikal> KupljeniArtikli = new List<Artikal>();
    public decimal UkupnaCena = 0;


    protected override async Task OnInitializedAsync()
    {

        KorpaServer = new HubConnectionBuilder().WithUrl(NM.ToAbsoluteUri("/habkorpa")).Build();


        KorpaServer.On<List<Artikal>>("KorpaMetoda", kArt =>

        {
            PoruceniArtikli= kArt;
            StateHasChanged();
        });


        await KorpaServer.StartAsync();

        if (LS.ContainKey ("CuvajKorpu"))
        {
            PoruceniArtikli = LS.GetItem<List<Artikal>>("CuvajKorpu");
        }
    }

    async Task ZavrsiRacun()
    {
        await KorpaServer.SendAsync("KorpaRacun", PoruceniArtikli);
        PoruceniArtikli.Clear();
    }

    public void UkloniIzKorpe(Artikal a)
    {
        PoruceniArtikli.Remove(a);
        LS.SetItem("CuvajKorpu", PoruceniArtikli);
    }
}
